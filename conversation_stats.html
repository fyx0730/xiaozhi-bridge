<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºAIå¯¹è¯æ—¶é•¿ç»Ÿè®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .conversations-list {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .conversation-item {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .conversation-item:hover {
            background-color: #f9f9f9;
        }
        
        .conversation-item:last-child {
            border-bottom: none;
        }
        
        .conversation-info {
            flex: 1;
        }
        
        .conversation-session {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
            font-family: monospace;
        }
        
        .conversation-duration {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .conversation-reason {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .conversation-time {
            font-size: 12px;
            color: #999;
            text-align: right;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.connected {
            background: #10b981;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        h1 {
            color: #333;
            margin-bottom: 16px;
        }
        
        h2 {
            color: #333;
            margin-bottom: 16px;
        }
        
        .connection-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .config-section label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .config-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .config-section button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .config-section button:hover {
            background: #5568d3;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-info">
                <h1>å°æ™ºAIå¯¹è¯æ—¶é•¿ç»Ÿè®¡</h1>
                <span id="status" class="status disconnected">æœªè¿æ¥</span>
            </div>
        </div>
        
        <div class="config-section">
            <label for="wsUrl">WebSocket æ¡¥æ¥åœ°å€:</label>
            <input type="text" id="wsUrl" placeholder="ws://localhost:8080" value="ws://localhost:8080">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" onclick="connectWebSocket()">è¿æ¥</button>
                <button type="button" onclick="clearData()" style="background: #ef4444;">æ¸…ç©ºæ•°æ®</button>
            </div>
            <div style="margin-top: 15px;">
                <label for="deviceFilter" style="display: block; margin-bottom: 5px;">ç­›é€‰è®¾å¤‡:</label>
                <select id="deviceFilter" onchange="filterByDevice(event)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">æ‰€æœ‰è®¾å¤‡</option>
                </select>
            </div>
            <p style="margin-top: 8px; font-size: 12px; color: #666;">
                ğŸ’¡ é»˜è®¤è¿æ¥åˆ°æœ¬åœ°æ¡¥æ¥æœåŠ¡ã€‚å¦‚æœæ¡¥æ¥æœåŠ¡è¿è¡Œåœ¨å…¶ä»–åœ°å€ï¼Œè¯·ä¿®æ”¹åè¿æ¥ã€‚<br>
                ğŸ’¡ æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚
            </p>
        </div>
        
        <div class="devices-section" style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
            <h3 style="margin-top: 0;">è®¾å¤‡åˆ—è¡¨</h3>
            <div id="devicesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                <div class="empty-state">æš‚æ— è®¾å¤‡æ•°æ®</div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">æ€»å¯¹è¯æ¬¡æ•°</div>
                <div class="stat-value" id="totalConversations">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ€»å¯¹è¯æ—¶é•¿</div>
                <div class="stat-value" id="totalDuration">0ç§’</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡å¯¹è¯æ—¶é•¿</div>
                <div class="stat-value" id="avgDuration">0ç§’</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€é•¿å¯¹è¯</div>
                <div class="stat-value" id="maxDuration">0ç§’</div>
            </div>
        </div>
        
        <div class="conversations-list">
            <h2>æœ€è¿‘å¯¹è¯è®°å½•</h2>
            <div id="conversationsList">
                <div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        class ConversationStats {
            constructor() {
                this.ws = null;
                this.conversations = [];
                this.totalDuration = 0;
                this.devices = new Map(); // è®¾å¤‡ç»Ÿè®¡
                this.selectedDeviceId = null; // å½“å‰é€‰ä¸­çš„è®¾å¤‡
                this.apiUrl = 'http://localhost:3000'; // API åœ°å€
                this.init();
            }
            
            init() {
                // ä» localStorage åŠ è½½ä¿å­˜çš„ WebSocket URL
                const savedUrl = localStorage.getItem('wsUrl');
                if (savedUrl) {
                    document.getElementById('wsUrl').value = savedUrl;
                }
                this.updateDisplay();
            }
            
            connect(wsUrl) {
                if (this.ws) {
                    this.ws.close();
                }
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    document.getElementById('status').textContent = 'å·²è¿æ¥';
                    document.getElementById('status').className = 'status connected';
                    
                    // åŠ è½½è®¾å¤‡åˆ—è¡¨
                    this.loadDevicesFromAPI();
                    
                    // å‘é€ hello æ¶ˆæ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    this.ws.send(JSON.stringify({
                        type: 'hello',
                        version: 1,
                        transport: 'websocket',
                        audio_params: {
                            format: 'opus',
                            sample_rate: 16000,
                            channels: 1,
                            frame_duration: 60
                        }
                    }));
                };
                
                this.ws.onmessage = (event) => {
                    console.log('ğŸ“¥ Raw message received:', event.data);
                    if (typeof event.data === 'string') {
                        try {
                            const message = JSON.parse(event.data);
                            console.log('âœ… Parsed message:', message);
                            this.handleMessage(message);
                        } catch (e) {
                            console.error('âŒ Failed to parse message:', e, 'Raw data:', event.data);
                        }
                    } else {
                        console.warn('âš ï¸  Received non-string message:', typeof event.data);
                    }
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    document.getElementById('status').textContent = 'è¿æ¥é”™è¯¯';
                    document.getElementById('status').className = 'status disconnected';
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket closed');
                    document.getElementById('status').textContent = 'å·²æ–­å¼€';
                    document.getElementById('status').className = 'status disconnected';
                };
            }
            
            handleMessage(message) {
                console.log('ğŸ“¨ Received message:', JSON.stringify(message, null, 2));
                
                // å¤„ç†æ¬¢è¿æ¶ˆæ¯
                if (message.type === 'welcome') {
                    console.log('âœ… Welcome message received:', message.message);
                    if (message.stats) {
                        console.log('ğŸ“Š Bridge stats:', message.stats);
                    }
                    if (message.devices) {
                        console.log('ğŸ“± Devices:', message.devices);
                        this.updateDevicesList(message.devices);
                    }
                    return;
                }
                
                // å¤„ç†å¿ƒè·³å“åº”
                if (message.type === 'pong') {
                    console.log('ğŸ’“ Pong received');
                    return;
                }
                
                // å¤„ç†å¯¹è¯ç»Ÿè®¡æ¶ˆæ¯
                if (message.type === 'conversation_stats') {
                    console.log('ğŸ“Š Received conversation stats:', {
                        device_id: message.device_id,
                        session_id: message.session_id,
                        duration: message.duration,
                        reason: message.reason,
                        timestamp: message.timestamp
                    });
                    
                    // éªŒè¯å¿…è¦å­—æ®µ
                    if (typeof message.duration !== 'number') {
                        console.error('âŒ Invalid duration:', message.duration);
                        return;
                    }
                    
                    // éªŒè¯å’Œä¿®å¤æ—¶é—´æˆ³
                    // å¦‚æœæ—¶é—´æˆ³æ— æ•ˆï¼ˆå°äº 2020-01-01ï¼‰ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
                    const minValidTimestamp = 1577836800; // 2020-01-01 00:00:00 UTC
                    let validTimestamp = message.timestamp || Math.floor(Date.now() / 1000);
                    if (validTimestamp < minValidTimestamp) {
                        console.warn(`âš ï¸  Invalid timestamp ${validTimestamp}, using current time`);
                        validTimestamp = Math.floor(Date.now() / 1000);
                    }
                    
                    const deviceId = message.device_id || 'unknown';
                    
                    // æ›´æ–°è®¾å¤‡ç»Ÿè®¡
                    if (!this.devices.has(deviceId)) {
                        this.devices.set(deviceId, {
                            deviceId: deviceId,
                            totalConversations: 0,
                            totalDuration: 0
                        });
                    }
                    const device = this.devices.get(deviceId);
                    device.totalConversations++;
                    device.totalDuration += message.duration;
                    
                    // å¦‚æœå½“å‰æ²¡æœ‰ç­›é€‰è®¾å¤‡ï¼Œæˆ–è€…åŒ¹é…å½“å‰è®¾å¤‡ï¼Œæ‰æ·»åŠ åˆ°æ˜¾ç¤ºåˆ—è¡¨
                    if (!this.selectedDeviceId || this.selectedDeviceId === deviceId) {
                        this.addConversation({
                            deviceId: deviceId,
                            sessionId: message.session_id || 'unknown',
                            duration: message.duration || 0,
                            reason: message.reason || 'unknown',
                            timestamp: validTimestamp
                        });
                    }
                    
                    // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
                    this.updateDevicesList(Array.from(this.devices.values()));
                } else {
                    console.log('âš ï¸  Unknown message type:', message.type, message);
                }
            }
            
            addConversation(conversation) {
                console.log('â• Adding conversation:', conversation);
                
                this.conversations.unshift(conversation); // æ·»åŠ åˆ°å¼€å¤´
                this.totalDuration += conversation.duration;
                
                // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
                if (this.conversations.length > 100) {
                    const removed = this.conversations.pop();
                    this.totalDuration -= removed.duration;
                }
                
                // ä¿å­˜åˆ° localStorage
                this.saveToLocalStorage();
                
                // æ›´æ–°æ˜¾ç¤º
                console.log('ğŸ”„ Updating display, total conversations:', this.conversations.length);
                this.updateDisplay();
                
                console.log('âœ… Conversation added successfully');
            }
            
            getDeviceDisplayName(device) {
                return device.deviceName || device.deviceId || 'unknown';
            }
            
            updateDevicesList(devices) {
                const devicesListEl = document.getElementById('devicesList');
                const deviceFilterEl = document.getElementById('deviceFilter');
                
                if (!devicesListEl || !deviceFilterEl) return;
                
                // æ›´æ–°è®¾å¤‡ç­›é€‰ä¸‹æ‹‰æ¡†
                const currentValue = deviceFilterEl.value;
                deviceFilterEl.innerHTML = '<option value="">æ‰€æœ‰è®¾å¤‡</option>';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    const displayName = this.getDeviceDisplayName(device);
                    option.textContent = `${displayName} (${device.totalConversations}æ¬¡å¯¹è¯)`;
                    if (currentValue === device.deviceId) {
                        option.selected = true;
                    }
                    deviceFilterEl.appendChild(option);
                });
                
                // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
                if (devices.length === 0) {
                    devicesListEl.innerHTML = '<div class="empty-state">æš‚æ— è®¾å¤‡æ•°æ®</div>';
                    return;
                }
                
                devicesListEl.innerHTML = devices.map(device => {
                    const displayName = this.getDeviceDisplayName(device);
                    return `
                    <div class="stat-card" style="cursor: pointer; position: relative;" onclick="selectDevice('${device.deviceId}')">
                        <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
                            <button type="button" onclick="event.stopPropagation(); editDeviceName('${device.deviceId}', '${(device.deviceName || '').replace(/'/g, "\\'")}')" 
                                    style="padding: 4px 8px; font-size: 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ${device.deviceName ? 'âœï¸' : 'â•'} åç§°
                            </button>
                            <button type="button" onclick="event.stopPropagation(); deleteDevice('${device.deviceId}', '${displayName.replace(/'/g, "\\'")}')" 
                                    style="padding: 4px 8px; font-size: 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                        <div class="stat-label">${device.deviceName ? 'è®¾å¤‡åç§°' : 'è®¾å¤‡ ID'}</div>
                        <div class="stat-value" style="font-size: ${device.deviceName ? '16px' : '14px'}; word-break: break-all;">
                            ${displayName}
                            ${device.deviceName ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">${device.deviceId}</div>` : ''}
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <div>å¯¹è¯æ¬¡æ•°: ${device.totalConversations}</div>
                            <div>æ€»æ—¶é•¿: ${this.formatDuration(device.totalDuration)}</div>
                            <div>å¹³å‡æ—¶é•¿: ${device.totalConversations > 0 ? this.formatDuration(device.totalDuration / device.totalConversations) : '0ç§’'}</div>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            async setDeviceName(deviceId, name) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/api/devices/${encodeURIComponent(deviceId)}/name`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log(`âœ… Device name set: ${deviceId} -> ${name}`);
                        // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                        await this.loadDevicesFromAPI();
                        return true;
                    } else {
                        console.error('Failed to set device name:', data.error);
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to set device name:', error);
                    return false;
                }
            }
            
            async deleteDeviceName(deviceId) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/api/devices/${encodeURIComponent(deviceId)}/name`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log(`âœ… Device name removed: ${deviceId}`);
                        // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                        await this.loadDevicesFromAPI();
                        return true;
                    } else {
                        console.error('Failed to delete device name:', data.error);
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to delete device name:', error);
                    return false;
                }
            }
            
            async deleteDevice(deviceId) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/api/devices/${encodeURIComponent(deviceId)}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log(`âœ… Device deleted: ${deviceId} (${data.deletedConversations} conversations)`);
                        
                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è®¾å¤‡ï¼Œæ¸…é™¤ç­›é€‰
                        if (this.selectedDeviceId === deviceId) {
                            this.selectedDeviceId = null;
                            const deviceFilterEl = document.getElementById('deviceFilter');
                            if (deviceFilterEl) deviceFilterEl.value = '';
                        }
                        
                        // ä»æœ¬åœ°è®¾å¤‡ Map ä¸­ç§»é™¤
                        this.devices.delete(deviceId);
                        
                        // åˆ é™¤è¯¥è®¾å¤‡çš„æ‰€æœ‰å¯¹è¯è®°å½•
                        const beforeCount = this.conversations.length;
                        this.conversations = this.conversations.filter(c => c.deviceId !== deviceId);
                        const deletedCount = beforeCount - this.conversations.length;
                        
                        // é‡æ–°è®¡ç®—æ€»æ—¶é•¿
                        this.totalDuration = this.conversations.reduce((sum, c) => sum + c.duration, 0);
                        
                        // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                        await this.loadDevicesFromAPI();
                        
                        // æ›´æ–°æ˜¾ç¤º
                        this.updateDisplay();
                        
                        // ä¿å­˜åˆ° localStorage
                        this.saveToLocalStorage();
                        
                        return true;
                    } else {
                        console.error('Failed to delete device:', data.error);
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to delete device:', error);
                    return false;
                }
            }
            
            async loadDevicesFromAPI() {
                try {
                    // ä» WebSocket URL æ¨æ–­ API URL
                    const wsUrl = document.getElementById('wsUrl')?.value || '';
                    let apiUrl = this.apiUrl;
                    
                    // å¦‚æœ WebSocket URL æ˜¯ ws://localhost:8080ï¼Œåˆ™ API æ˜¯ http://localhost:3000
                    // å¦‚æœ WebSocket URL æ˜¯ ws://127.0.0.1:8080ï¼Œåˆ™ API æ˜¯ http://127.0.0.1:3000
                    if (wsUrl.includes('127.0.0.1')) {
                        apiUrl = 'http://127.0.0.1:3000';
                    } else if (wsUrl.includes('localhost')) {
                        apiUrl = 'http://localhost:3000';
                    } else {
                        // å°è¯•ä» WebSocket URL æå–ä¸»æœºå’Œç«¯å£
                        const wsMatch = wsUrl.match(/ws[s]?:\/\/([^:]+):(\d+)/);
                        if (wsMatch) {
                            const host = wsMatch[1];
                            const wsPort = parseInt(wsMatch[2]);
                            // API ç«¯å£é€šå¸¸æ˜¯ WebSocket ç«¯å£ - 1000ï¼ˆ8080 -> 3000ï¼‰
                            const apiPort = wsPort === 8080 ? 3000 : wsPort - 1000;
                            apiUrl = `http://${host}:${apiPort}`;
                        }
                    }
                    
                    console.log(`ğŸ“¡ Loading devices from API: ${apiUrl}/api/devices`);
                    const response = await fetch(`${apiUrl}/api/devices`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success && data.devices) {
                        console.log(`âœ… Loaded ${data.devices.length} devices`);
                        this.updateDevicesList(data.devices);
                        // æ›´æ–°æœ¬åœ°è®¾å¤‡ Map
                        data.devices.forEach(device => {
                            this.devices.set(device.deviceId, device);
                        });
                    }
                } catch (error) {
                    console.error('âŒ Failed to load devices:', error);
                    console.error('ğŸ’¡ Make sure the bridge service is running on port 3000');
                }
            }
            
            saveToLocalStorage() {
                try {
                    localStorage.setItem('conversations', JSON.stringify({
                        conversations: this.conversations,
                        totalDuration: this.totalDuration,
                        selectedDeviceId: this.selectedDeviceId
                    }));
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                }
            }
            
            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('conversations');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.conversations = data.conversations || [];
                        this.totalDuration = data.totalDuration || 0;
                        this.selectedDeviceId = data.selectedDeviceId || null;
                        
                        // é‡å»ºè®¾å¤‡ç»Ÿè®¡
                        this.devices.clear();
                        this.conversations.forEach(conv => {
                            const deviceId = conv.deviceId || 'unknown';
                            if (!this.devices.has(deviceId)) {
                                this.devices.set(deviceId, {
                                    deviceId: deviceId,
                                    totalConversations: 0,
                                    totalDuration: 0
                                });
                            }
                            const device = this.devices.get(deviceId);
                            device.totalConversations++;
                            device.totalDuration += conv.duration;
                        });
                        
                        this.updateDevicesList(Array.from(this.devices.values()));
                        
                        // æ¢å¤è®¾å¤‡ç­›é€‰
                        const deviceFilterEl = document.getElementById('deviceFilter');
                        if (deviceFilterEl && this.selectedDeviceId) {
                            deviceFilterEl.value = this.selectedDeviceId;
                        }
                        
                        this.updateDisplay();
                    }
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                }
            }
            
            formatDuration(seconds) {
                if (seconds < 60) {
                    return seconds.toFixed(1) + 'ç§’';
                } else if (seconds < 3600) {
                    const mins = Math.floor(seconds / 60);
                    const secs = (seconds % 60).toFixed(1);
                    return mins + 'åˆ†' + secs + 'ç§’';
                } else {
                    const hours = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    return hours + 'å°æ—¶' + mins + 'åˆ†é’Ÿ';
                }
            }
            
            formatTime(timestamp) {
                const date = new Date(timestamp * 1000);
                return date.toLocaleString('zh-CN');
            }
            
            updateDisplay() {
                // æ ¹æ®é€‰ä¸­çš„è®¾å¤‡ç­›é€‰ç»Ÿè®¡
                let filteredConversations = this.conversations;
                if (this.selectedDeviceId) {
                    filteredConversations = this.conversations.filter(c => c.deviceId === this.selectedDeviceId);
                }
                
                const count = filteredConversations.length;
                const total = filteredConversations.reduce((sum, c) => sum + c.duration, 0);
                const avg = count > 0 ? total / count : 0;
                const max = count > 0 ? Math.max(...filteredConversations.map(c => c.duration)) : 0;
                
                console.log('ğŸ“Š Display stats:', { count, total, avg, max, deviceId: this.selectedDeviceId });
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                const totalConversationsEl = document.getElementById('totalConversations');
                const totalDurationEl = document.getElementById('totalDuration');
                const avgDurationEl = document.getElementById('avgDuration');
                const maxDurationEl = document.getElementById('maxDuration');
                
                if (totalConversationsEl) totalConversationsEl.textContent = count;
                if (totalDurationEl) totalDurationEl.textContent = this.formatDuration(total);
                if (avgDurationEl) avgDurationEl.textContent = this.formatDuration(avg);
                if (maxDurationEl) maxDurationEl.textContent = this.formatDuration(max);
                
                // æ›´æ–°å¯¹è¯åˆ—è¡¨
                const listElement = document.getElementById('conversationsList');
                if (!listElement) {
                    console.error('âŒ conversationsList element not found');
                    return;
                }
                
                if (filteredConversations.length === 0) {
                    listElement.innerHTML = '<div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>';
                } else {
                    listElement.innerHTML = filteredConversations.map(conv => {
                        const device = this.devices.get(conv.deviceId);
                        const deviceDisplayName = device ? this.getDeviceDisplayName(device) : conv.deviceId || 'unknown';
                        return `
                        <div class="conversation-item">
                            <div class="conversation-info">
                                <div class="conversation-session">è®¾å¤‡: ${deviceDisplayName}</div>
                                <div class="conversation-session">ä¼šè¯ID: ${conv.sessionId}</div>
                                <div class="conversation-duration">${this.formatDuration(conv.duration)}</div>
                                <div class="conversation-reason">ç»“æŸåŸå› : ${conv.reason}</div>
                            </div>
                            <div class="conversation-time">${this.formatTime(conv.timestamp)}</div>
                        </div>
                    `;
                    }).join('');
                }
                
                console.log('âœ… Display updated');
            }
        }
        
        // å…¨å±€å‡½æ•°
        function connectWebSocket(event) {
            // é˜²æ­¢è¡¨å•æäº¤
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const wsUrl = document.getElementById('wsUrl').value;
            if (!wsUrl) {
                alert('è¯·è¾“å…¥ WebSocket åœ°å€');
                return false;
            }
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('wsUrl', wsUrl);
            
            // è¿æ¥
            stats.connect(wsUrl);
            return false;
        }
        
        // æ¸…ç©ºæ•°æ®
        function clearData(event) {
            // é˜²æ­¢è¡¨å•æäº¤
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                stats.conversations = [];
                stats.totalDuration = 0;
                stats.devices.clear();
                stats.selectedDeviceId = null;
                localStorage.removeItem('conversations');
                const deviceFilterEl = document.getElementById('deviceFilter');
                if (deviceFilterEl) deviceFilterEl.value = '';
                stats.updateDisplay();
                stats.updateDevicesList([]);
                console.log('ğŸ—‘ï¸  Data cleared');
            }
            return false;
        }
        
        // è·å– API URLï¼ˆä» WebSocket URL æ¨æ–­ï¼‰
        function getApiUrl() {
            const wsUrl = document.getElementById('wsUrl')?.value || '';
            let apiUrl = 'http://localhost:3000';
            
            if (wsUrl.includes('127.0.0.1')) {
                apiUrl = 'http://127.0.0.1:3000';
            } else if (wsUrl.includes('localhost')) {
                apiUrl = 'http://localhost:3000';
            } else {
                // å°è¯•ä» WebSocket URL æå–ä¸»æœºå’Œç«¯å£
                const wsMatch = wsUrl.match(/ws[s]?:\/\/([^:]+):(\d+)/);
                if (wsMatch) {
                    const host = wsMatch[1];
                    const wsPort = parseInt(wsMatch[2]);
                    // API ç«¯å£é€šå¸¸æ˜¯ WebSocket ç«¯å£ - 1000ï¼ˆ8080 -> 3000ï¼‰
                    const apiPort = wsPort === 8080 ? 3000 : wsPort - 1000;
                    apiUrl = `http://${host}:${apiPort}`;
                }
            }
            
            return apiUrl;
        }
        
        // ç­›é€‰è®¾å¤‡
        async function filterByDevice(event) {
            // é˜²æ­¢è¡¨å•æäº¤
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const deviceFilterEl = document.getElementById('deviceFilter');
            const selectedDeviceId = deviceFilterEl ? deviceFilterEl.value : '';
            const apiUrl = getApiUrl();
            
            stats.selectedDeviceId = selectedDeviceId || null;
            
            // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
            if (selectedDeviceId) {
                // ä» API åŠ è½½è¯¥è®¾å¤‡çš„å¯¹è¯
                try {
                    const response = await fetch(`${apiUrl}/api/conversations?device_id=${encodeURIComponent(selectedDeviceId)}&limit=100`);
                    const data = await response.json();
                    if (data.success) {
                        // æ¸…ç©ºå½“å‰åˆ—è¡¨ï¼Œé‡æ–°åŠ è½½
                        stats.conversations = [];
                        stats.totalDuration = 0;
                        data.conversations.forEach(conv => {
                            stats.addConversation(conv);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load device conversations:', error);
                }
            } else {
                // åŠ è½½æ‰€æœ‰è®¾å¤‡çš„å¯¹è¯
                try {
                    const response = await fetch(`${apiUrl}/api/conversations?limit=100`);
                    const data = await response.json();
                    if (data.success) {
                        stats.conversations = [];
                        stats.totalDuration = 0;
                        data.conversations.forEach(conv => {
                            stats.addConversation(conv);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load all conversations:', error);
                }
            }
            
            stats.updateDisplay();
            return false;
        }
        
        // é€‰æ‹©è®¾å¤‡
        function selectDevice(deviceId) {
            const deviceFilterEl = document.getElementById('deviceFilter');
            if (deviceFilterEl) {
                deviceFilterEl.value = deviceId;
                filterByDevice();
            }
        }
        
        // ç¼–è¾‘è®¾å¤‡åç§°
        function editDeviceName(deviceId, currentName) {
            const name = prompt(`è¯·è¾“å…¥è®¾å¤‡åç§°ï¼ˆè®¾å¤‡ID: ${deviceId}ï¼‰:`, currentName || '');
            if (name !== null) {
                const trimmedName = name.trim();
                if (trimmedName.length === 0) {
                    // å¦‚æœåç§°ä¸ºç©ºï¼Œåˆ é™¤è®¾å¤‡åç§°
                    if (confirm('ç¡®å®šè¦åˆ é™¤è®¾å¤‡åç§°å—ï¼Ÿ')) {
                        stats.deleteDeviceName(deviceId);
                    }
                } else {
                    stats.setDeviceName(deviceId, trimmedName);
                }
            }
        }
        
        // åˆ é™¤è®¾å¤‡
        function deleteDevice(deviceId, deviceDisplayName) {
            const device = Array.from(stats.devices.values()).find(d => d.deviceId === deviceId);
            const conversationCount = device ? device.totalConversations : 0;
            
            let confirmMessage = `ç¡®å®šè¦åˆ é™¤è®¾å¤‡ "${deviceDisplayName}" å—ï¼Ÿ\n\n`;
            confirmMessage += `è¿™å°†åˆ é™¤ï¼š\n`;
            confirmMessage += `- ${conversationCount} æ¡å¯¹è¯è®°å½•\n`;
            confirmMessage += `- è®¾å¤‡åç§°ï¼ˆå¦‚æœå·²è®¾ç½®ï¼‰\n\n`;
            confirmMessage += `æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
            
            if (confirm(confirmMessage)) {
                stats.deleteDevice(deviceId).then(success => {
                    if (success) {
                        alert(`è®¾å¤‡ "${deviceDisplayName}" å·²åˆ é™¤`);
                    } else {
                        alert(`åˆ é™¤è®¾å¤‡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…`);
                    }
                });
            }
        }
        
        // åˆå§‹åŒ–
        const stats = new ConversationStats();
        
        // é¡µé¢åŠ è½½æ—¶ä» localStorage æ¢å¤æ•°æ®
        stats.loadFromLocalStorage();
        
        // æ·»åŠ å…¨å±€è°ƒè¯•å‡½æ•°
        window.stats = stats;
        console.log('ğŸ’¡ è°ƒè¯•æç¤ºï¼šåœ¨æ§åˆ¶å°è¾“å…¥ stats æŸ¥çœ‹ç»Ÿè®¡å¯¹è±¡');
    </script>
</body>
</html>

