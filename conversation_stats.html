<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å±•ç¤ºæ¡†ï¼ˆå°æ™ºï¼‰æ•°æ®çœ‹æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* æ ¸å¿ƒé…è‰²ï¼šé›é’è‰² + ç°ç™½ */
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --success: #10b981;
            --danger: #ef4444;
            --border: #e5e7eb;
            
            /* é˜´å½±ä¸åœ†è§’ */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            padding: 24px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding-bottom: 40px;
        }
        
        /* --- Header Section --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 0 8px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1::before {
            content: '';
            display: block;
            width: 6px;
            height: 28px;
            background: var(--primary);
            border-radius: 4px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status.connected .status-dot { background: var(--success); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        .status.disconnected .status-dot { background: var(--danger); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); }
        
        /* --- Global Card Styles --- */
        .section-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.5);
        }

        h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* --- Stats Grid (Top) --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-value {
            font-size: 30px;
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.03em;
        }
        
        /* --- Inputs & Controls --- */
        .filter-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        input[type="text"], select {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-main);
            background-color: #f9fafb;
            transition: all 0.2s;
        }

        input[type="text"]:focus, select:focus {
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* --- Device Management (Left Column) --- */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 600px;
            overflow-y: auto;
            padding: 4px; 
        }

        .device-card {
            border: 1px solid var(--border);
            padding: 20px;
            cursor: pointer;
            position: relative;
        }

        .device-card:hover {
            border-color: var(--primary);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .device-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            word-break: break-word;
        }

        .device-id {
            font-size: 12px;
            color: var(--text-light);
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        .device-stats-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f3f4f6;
        }

        .device-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            background: rgba(255,255,255,0.95);
            padding-left: 10px;
            border-radius: 6px;
        }

        .device-card:hover .device-actions {
            opacity: 1;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-edit { background: #e0e7ff; color: var(--primary); }
        .btn-edit:hover { background: var(--primary); color: white; }
        
        .btn-delete { background: #fee2e2; color: var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }

        /* --- Ranking List (Optimized) --- */
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .ranking-item:hover {
            transform: translateX(4px);
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .rank-badge {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .rank-1 { background: linear-gradient(135deg, #FEF3C7 0%, #F59E0B 100%); color: #78350F; }
        .rank-2 { background: linear-gradient(135deg, #F3F4F6 0%, #9CA3AF 100%); color: #374151; }
        .rank-3 { background: linear-gradient(135deg, #FFEDD5 0%, #EA580C 100%); color: #7C2D12; }
        .rank-other { background: #F3F4F6; color: var(--text-secondary); font-size: 12px; }

        .ranking-details {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr auto auto; 
            gap: 12px;
            align-items: center;
            min-width: 0; /* é˜²æ­¢ Grid æº¢å‡º */
        }

        .ranking-name { 
            font-weight: 600; 
            color: var(--text-main);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-time { 
            font-weight: 700; 
            color: var(--primary); 
            font-size: 14px;
            white-space: nowrap;
        }

        .ranking-count { 
            font-size: 12px; 
            color: var(--text-light);
            white-space: nowrap;
            background: #f9fafb;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* --- Conversation List (Optimized) --- */
        .conversations-list-container {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: white;
        }

        .conversation-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            gap: 16px;
        }

        .conversation-item:last-child { border-bottom: none; }
        .conversation-item:hover { background: #f9fafb; }

        /* å·¦ä¾§ä¿¡æ¯ */
        .conv-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .conv-device {
            font-weight: 600;
            color: var(--text-main);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conv-reason {
            font-size: 12px;
            color: var(--text-secondary);
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
            align-self: flex-start;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å³ä¾§æ•°æ® */
        .conv-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }

        .conv-duration {
            font-family: 'Inter', ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
        }

        .conv-time {
            font-size: 12px;
            color: #9ca3af;
        }

        /* --- Buttons & Utils --- */
        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn-primary:hover { background: var(--primary-hover); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: var(--text-light);
            font-size: 14px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed var(--border);
        }

        /* --- Responsive --- */
        @media (max-width: 1024px) {
            .container { max-width: 100%; }
        }

        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 16px; }
            .stats-grid { grid-template-columns: 1fr; }
            
            /* ç§»åŠ¨ç«¯éšè—æ’è¡Œæ¦œæ¬¡æ•°ï¼Œä¼˜å…ˆæ˜¾ç¤ºåå­—å’Œæ—¶é•¿ */
            .ranking-details { grid-template-columns: 1fr auto; }
            .ranking-count { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>AI å±•ç¤ºæ¡†æ•°æ®çœ‹æ¿</h1>
                <p style="color: var(--text-secondary); margin-top: 4px; font-size: 14px;">å®æ—¶ç›‘æ§è®¾å¤‡è¿æ¥ä¸å¯¹è¯æ—¶é•¿ç»Ÿè®¡</p>
            </div>
            <div class="connection-status">
                <span id="status" class="status disconnected">
                    <span class="status-dot"></span>
                    <span id="statusText">æœªè¿æ¥</span>
                </span>
            </div>
        </div>
        
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    æ€»å¯¹è¯æ¬¡æ•°
                </div>
                <div class="stat-value" id="totalConversations">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    æ€»å¯¹è¯æ—¶é•¿
                </div>
                <div class="stat-value" id="totalDuration">0ç§’</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    å¹³å‡å¯¹è¯æ—¶é•¿
                </div>
                <div class="stat-value" id="avgDuration">0ç§’</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    æœ€é•¿å•æ¬¡å¯¹è¯
                </div>
                <div class="stat-value" id="maxDuration">0ç§’</div>
            </div>
        </div>

        <!-- Main Content Grid: å·¦ä¾§è®¾å¤‡ç®¡ç† (2åˆ—å®½)ï¼Œå³ä¾§æ’è¡Œä¸è®°å½• (1åˆ—å®½) -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
            
            <!-- Left Column: Configuration & Devices -->
            <div style="grid-column: span 2;">
                <div class="section-card">
                    <h2>
                        è®¾å¤‡ç®¡ç†
                        <div class="devices-search" style="width: 250px;">
                            <input type="text" id="deviceSearch" placeholder="æœç´¢è®¾å¤‡åç§°æˆ–ID..." oninput="filterDevicesList()">
                        </div>
                    </h2>
                    
                    <div class="filter-bar">
                        <div style="flex: 1;">
                            <select id="deviceFilter" onchange="filterByDevice(event)">
                                <option value="">æ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡æ•°æ®</option>
                            </select>
                        </div>
                    </div>

                    <div class="devices-container">
                        <div id="devicesList" class="devices-grid">
                            <div class="empty-state">æš‚æ— è®¾å¤‡æ•°æ®</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Ranking & Recent -->
            <div style="grid-column: span 1;">
                <!-- Ranking -->
                <div class="section-card">
                    <h2>
                        æ´»è·ƒæ’è¡Œ
                        <button type="button" onclick="exportRankingToExcel()" class="btn-primary" id="exportRankingBtn" style="display: none; font-size: 12px; padding: 6px 12px;">
                            å¯¼å‡º CSV
                        </button>
                    </h2>
                    <div id="rankingList" class="ranking-list">
                        <div class="empty-state">æš‚æ— æ•°æ®</div>
                    </div>
                </div>

                <!-- Recent Conversations -->
                <div class="section-card">
                    <h2>æœ€è¿‘å¯¹è¯</h2>
                    <div class="conversations-list-container" id="conversationsList">
                        <div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ConversationStats {
            constructor() {
                this.ws = null;
                this.conversations = [];
                this.totalDuration = 0;
                this.devices = new Map(); 
                this.selectedDeviceId = null; 
                this.apiUrl = 'https://api.xiaozhi.aimaker.space/api'; 
                this.reconnectTimer = null; 
                this.fixedWsUrl = 'wss://api.xiaozhi.aimaker.space/ws'; 
                this.init();
            }
            
            init() {
                this.connect(this.fixedWsUrl);
                this.updateDisplay();
            }
            
            connect(wsUrl) {
                if (this.ws) {
                    this.ws.close();
                }
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    const statusEl = document.getElementById('status');
                    const statusTextEl = document.getElementById('statusText') || statusEl;
                    
                    statusEl.className = 'status connected';
                    if(document.getElementById('statusText')) {
                        document.getElementById('statusText').textContent = 'å·²è¿æ¥';
                    } else {
                        statusEl.innerHTML = '<span class="status-dot"></span> å·²è¿æ¥';
                    }
                    
                    if (this.reconnectTimer) {
                        clearTimeout(this.reconnectTimer);
                        this.reconnectTimer = null;
                    }
                    
                    this.loadDevicesFromAPI();
                    
                    this.ws.send(JSON.stringify({
                        type: 'hello',
                        version: 1,
                        transport: 'websocket',
                        audio_params: {
                            format: 'opus',
                            sample_rate: 16000,
                            channels: 1,
                            frame_duration: 60
                        }
                    }));
                };
                
                this.ws.onmessage = (event) => {
                    if (typeof event.data === 'string') {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleMessage(message);
                        } catch (e) {
                            console.error('Failed to parse message:', e);
                        }
                    }
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    const statusEl = document.getElementById('status');
                    statusEl.className = 'status disconnected';
                    if(document.getElementById('statusText')) {
                        document.getElementById('statusText').textContent = 'è¿æ¥é”™è¯¯';
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket closed');
                    const statusEl = document.getElementById('status');
                    statusEl.className = 'status disconnected';
                    if(document.getElementById('statusText')) {
                        document.getElementById('statusText').textContent = 'å·²æ–­å¼€';
                    }
                    
                    if (!this.reconnectTimer) {
                        this.reconnectTimer = setTimeout(() => {
                            this.reconnectTimer = null;
                            this.connect(wsUrl);
                        }, 5000);
                    }
                };
            }
            
            handleMessage(message) {
                if (message.type === 'welcome') {
                    if (message.devices) {
                        this.updateDevicesList(message.devices);
                    }
                    return;
                }
                
                if (message.type === 'pong') return;
                
                if (message.type === 'conversation_stats') {
                    if (typeof message.duration !== 'number') return;
                    
                    const minValidTimestamp = 1577836800;
                    let validTimestamp = message.timestamp || Math.floor(Date.now() / 1000);
                    if (validTimestamp < minValidTimestamp) {
                        validTimestamp = Math.floor(Date.now() / 1000);
                    }
                    
                    if (!message.device_id) return;
                    
                    const deviceId = message.device_id;
                    
                    if (!this.devices.has(deviceId)) {
                        this.devices.set(deviceId, {
                            deviceId: deviceId,
                            totalConversations: 0,
                            totalDuration: 0
                        });
                    }
                    const device = this.devices.get(deviceId);
                    device.totalConversations++;
                    device.totalDuration += message.duration;
                    
                    if (!this.selectedDeviceId || this.selectedDeviceId === deviceId) {
                        this.addConversation({
                            deviceId: deviceId,
                            sessionId: message.session_id || 'unknown',
                            duration: message.duration || 0,
                            reason: message.reason || 'unknown',
                            timestamp: validTimestamp
                        });
                    }
                    
                    this.updateDevicesList(Array.from(this.devices.values()));
                }
            }
            
            addConversation(conversation) {
                this.conversations.unshift(conversation);
                this.totalDuration += conversation.duration;
                
                if (this.conversations.length > 100) {
                    const removed = this.conversations.pop();
                    this.totalDuration -= removed.duration;
                }
                
                this.saveToLocalStorage();
                this.updateDisplay();
            }
            
            getDeviceDisplayName(device) {
                return device.deviceName || device.deviceId || 'unknown';
            }
            
            updateDevicesList(devices) {
                devices = devices.filter(device => 
                    device.deviceId && 
                    device.deviceId !== 'unknown' && 
                    device.deviceId !== '' && 
                    device.deviceId !== null
                );
                
                this.allDevices = devices;
                
                const devicesListEl = document.getElementById('devicesList');
                const deviceFilterEl = document.getElementById('deviceFilter');
                
                if (!devicesListEl || !deviceFilterEl) return;
                
                const currentValue = deviceFilterEl.value;
                deviceFilterEl.innerHTML = '<option value="">æ‰€æœ‰è®¾å¤‡</option>';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    const displayName = this.getDeviceDisplayName(device);
                    option.textContent = `${displayName} (${device.totalConversations}æ¬¡å¯¹è¯)`;
                    if (currentValue === device.deviceId) {
                        option.selected = true;
                    }
                    deviceFilterEl.appendChild(option);
                });
                
                this.renderDevicesList(devices);
                this.updateRanking(devices);
            }
            
            renderDevicesList(devices) {
                const devicesListEl = document.getElementById('devicesList');
                if (!devicesListEl) return;
                
                const searchInput = document.getElementById('deviceSearch');
                const searchKeyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
                
                let filteredDevices = devices;
                if (searchKeyword) {
                    filteredDevices = devices.filter(device => {
                        const displayName = this.getDeviceDisplayName(device).toLowerCase();
                        const deviceId = (device.deviceId || '').toLowerCase();
                        return displayName.includes(searchKeyword) || deviceId.includes(searchKeyword);
                    });
                }
                
                if (filteredDevices.length === 0) {
                    devicesListEl.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">' + 
                        (searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡' : 'æš‚æ— è®¾å¤‡æ•°æ®') + 
                        '</div>';
                    return;
                }
                
                devicesListEl.innerHTML = filteredDevices.map(device => {
                    const displayName = this.getDeviceDisplayName(device);
                    const safeName = (device.deviceName || '').replace(/'/g, "\\'");
                    const safeDisplayName = displayName.replace(/'/g, "\\'");
                    
                    return `
                    <div class="stat-card device-card" onclick="selectDevice('${device.deviceId}')">
                        <div class="device-actions">
                            <button type="button" class="btn-icon btn-edit" title="ç¼–è¾‘åç§°" onclick="event.stopPropagation(); editDeviceName('${device.deviceId}', '${safeName}')">
                                âœ
                            </button>
                            <button type="button" class="btn-icon btn-delete" title="åˆ é™¤è®¾å¤‡" onclick="event.stopPropagation(); deleteDevice('${device.deviceId}', '${safeDisplayName}')">
                                ğŸ—‘
                            </button>
                        </div>
                        <div class="device-header">
                            <div>
                                <div class="device-name">${displayName}</div>
                                ${device.deviceName ? `<div class="device-id">${device.deviceId}</div>` : ''}
                            </div>
                        </div>
                        <div class="device-stats-row">
                            <div>å¯¹è¯: <strong>${device.totalConversations}</strong></div>
                            <div>æ€»æ—¶: <strong>${this.formatDuration(device.totalDuration)}</strong></div>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            updateRanking(devices) {
                const rankingListEl = document.getElementById('rankingList');
                const exportBtn = document.getElementById('exportRankingBtn');
                if (!rankingListEl) return;
                
                const rankedDevices = devices
                    .filter(device => 
                        device.deviceId && 
                        device.deviceId !== 'unknown' && 
                        device.deviceId !== '' && 
                        device.deviceId !== null &&
                        device.totalDuration > 0
                    )
                    .sort((a, b) => (b.totalDuration || 0) - (a.totalDuration || 0));
                
                this.rankedDevices = rankedDevices;
                
                if (exportBtn) {
                    exportBtn.style.display = rankedDevices.length > 0 ? 'inline-flex' : 'none';
                }
                
                if (rankedDevices.length === 0) {
                    rankingListEl.innerHTML = '<div class="empty-state">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>';
                    return;
                }
                
                rankingListEl.innerHTML = rankedDevices.map((device, index) => {
                    const rank = index + 1;
                    const displayName = this.getDeviceDisplayName(device);
                    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                    const rankDisplay = rank <= 3 ? rank : rank;
                    
                    return `
                        <div class="ranking-item" onclick="selectDevice('${device.deviceId}')">
                            <div class="rank-badge ${rankClass}">${rankDisplay}</div>
                            <div class="ranking-details">
                                <div class="ranking-name" title="${displayName}">${displayName}</div>
                                <div class="ranking-time">${this.formatDuration(device.totalDuration)}</div>
                                <div class="ranking-count">${device.totalConversations}æ¬¡</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            exportRankingToExcel() {
                if (!this.rankedDevices || this.rankedDevices.length === 0) {
                    alert('æš‚æ— æ’è¡Œæ¦œæ•°æ®å¯å¯¼å‡º');
                    return;
                }
                
                const headers = ['æ’å', 'æ ¡åŒº/è®¾å¤‡', 'ä½¿ç”¨æ—¶é•¿', 'å¯¹è¯æ¬¡æ•°'];
                const rows = this.rankedDevices.map((device, index) => {
                    const rank = index + 1;
                    const campus = this.getDeviceDisplayName(device);
                    const duration = this.formatDuration(device.totalDuration);
                    const conversations = device.totalConversations || 0;
                    
                    return [rank, campus, duration, conversations];
                });
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => {
                        const cellStr = String(cell);
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    }).join(','))
                ].join('\n');
                
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const now = new Date();
                const dateStr = now.getFullYear() + 
                               String(now.getMonth() + 1).padStart(2, '0') + 
                               String(now.getDate()).padStart(2, '0');
                link.setAttribute('download', `æ’è¡Œæ¦œ_${dateStr}.csv`);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            async setDeviceName(deviceId, name) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/devices/${encodeURIComponent(deviceId)}/name`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        await this.loadDevicesFromAPI();
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Failed to set device name:', error);
                    return false;
                }
            }
            
            async deleteDeviceName(deviceId) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/devices/${encodeURIComponent(deviceId)}/name`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        await this.loadDevicesFromAPI();
                        return true;
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            }
            
            async deleteDevice(deviceId) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/devices/${encodeURIComponent(deviceId)}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        if (this.selectedDeviceId === deviceId) {
                            this.selectedDeviceId = null;
                            const deviceFilterEl = document.getElementById('deviceFilter');
                            if (deviceFilterEl) deviceFilterEl.value = '';
                        }
                        
                        this.devices.delete(deviceId);
                        this.conversations = this.conversations.filter(c => c.deviceId !== deviceId);
                        this.totalDuration = this.conversations.reduce((sum, c) => sum + c.duration, 0);
                        
                        await this.loadDevicesFromAPI();
                        this.updateDisplay();
                        this.saveToLocalStorage();
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            }
            
            async loadDevicesFromAPI() {
                try {
                    const apiUrl = this.apiUrl;
                    const response = await fetch(`${apiUrl}/devices`);
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    if (data.success && data.devices) {
                        this.devices.clear();
                        data.devices.forEach(device => {
                            this.devices.set(device.deviceId, device);
                        });
                        this.updateDevicesList(data.devices);
                        this.updateDisplay();
                    }
                } catch (error) {
                    console.error('Failed to load devices:', error);
                }
            }
            
            saveToLocalStorage() {
                try {
                    localStorage.setItem('conversations', JSON.stringify({
                        conversations: this.conversations,
                        totalDuration: this.totalDuration,
                        selectedDeviceId: this.selectedDeviceId
                    }));
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                }
            }
            
            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('conversations');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.conversations = (data.conversations || []).filter(conv => 
                            conv.deviceId && conv.deviceId !== 'unknown'
                        );
                        this.selectedDeviceId = data.selectedDeviceId || null;
                        
                        const deviceFilterEl = document.getElementById('deviceFilter');
                        if (deviceFilterEl && this.selectedDeviceId) {
                            deviceFilterEl.value = this.selectedDeviceId;
                        }
                    }
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                }
            }
            
            formatDuration(seconds) {
                if (seconds < 60) {
                    return seconds.toFixed(1) + 'ç§’';
                } else if (seconds < 3600) {
                    const mins = Math.floor(seconds / 60);
                    const secs = (seconds % 60).toFixed(1);
                    return mins + 'åˆ†' + secs + 'ç§’';
                } else {
                    const hours = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    return hours + 'å°æ—¶' + mins + 'åˆ†é’Ÿ';
                }
            }
            
            formatTime(timestamp) {
                const utcTimestamp = timestamp - 8 * 3600;
                const date = new Date(utcTimestamp * 1000);
                const now = new Date();
                
                const isToday = date.getDate() === now.getDate() && 
                                date.getMonth() === now.getMonth() && 
                                date.getFullYear() === now.getFullYear();
                
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                if (isToday) {
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${hours}:${minutes}:${seconds}`;
                }
                
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${month}/${day} ${hours}:${minutes}`;
            }
            
            updateDisplay() {
                let devices = Array.from(this.devices.values()).filter(device => 
                    device.deviceId && device.deviceId !== 'unknown'
                );
                
                if (this.selectedDeviceId) {
                    devices = devices.filter(device => device.deviceId === this.selectedDeviceId);
                }
                
                const count = devices.reduce((sum, device) => sum + (device.totalConversations || 0), 0);
                const total = devices.reduce((sum, device) => sum + (device.totalDuration || 0), 0);
                const avg = count > 0 ? total / count : 0;
                
                let filteredConversations = this.conversations.filter(c => 
                    c.deviceId && c.deviceId !== 'unknown'
                );
                if (this.selectedDeviceId) {
                    filteredConversations = filteredConversations.filter(c => c.deviceId === this.selectedDeviceId);
                }
                const max = filteredConversations.length > 0 ? Math.max(...filteredConversations.map(c => c.duration || 0)) : 0;
                
                const totalConversationsEl = document.getElementById('totalConversations');
                const totalDurationEl = document.getElementById('totalDuration');
                const avgDurationEl = document.getElementById('avgDuration');
                const maxDurationEl = document.getElementById('maxDuration');
                
                if (totalConversationsEl) totalConversationsEl.textContent = count;
                if (totalDurationEl) totalDurationEl.textContent = this.formatDuration(total);
                if (avgDurationEl) avgDurationEl.textContent = this.formatDuration(avg);
                if (maxDurationEl) maxDurationEl.textContent = this.formatDuration(max);
                
                const listElement = document.getElementById('conversationsList');
                if (!listElement) return;
                
                if (filteredConversations.length === 0) {
                    listElement.innerHTML = '<div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>';
                } else {
                    const recentConversations = filteredConversations
                        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                        .slice(0, 5);
                    
                    listElement.innerHTML = recentConversations.map(conv => {
                        const device = this.devices.get(conv.deviceId);
                        const deviceDisplayName = device ? this.getDeviceDisplayName(device) : conv.deviceId;
                        const reasonText = conv.reason && conv.reason !== 'unknown' ? conv.reason : 'æœªçŸ¥åŸå› ';
                        
                        return `
                            <div class="conversation-item">
                                <div class="conv-info">
                                    <div class="conv-device" title="${deviceDisplayName}">${deviceDisplayName}</div>
                                    <div class="conv-reason" title="ç»“æŸåŸå› : ${reasonText}">${reasonText}</div>
                                </div>
                                <div class="conv-stats">
                                    <div class="conv-duration">${this.formatDuration(conv.duration)}</div>
                                    <div class="conv-time">${this.formatTime(conv.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function getApiUrl() {
            return 'https://api.xiaozhi.aimaker.space/api';
        }
        
        function exportRankingToExcel() {
            if (stats && stats.exportRankingToExcel) {
                stats.exportRankingToExcel();
            }
        }
        
        function filterDevicesList() {
            if (stats && stats.allDevices) {
                stats.renderDevicesList(stats.allDevices);
            }
        }
        
        async function filterByDevice(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const deviceFilterEl = document.getElementById('deviceFilter');
            const selectedDeviceId = deviceFilterEl ? deviceFilterEl.value : '';
            const apiUrl = getApiUrl();
            
            stats.selectedDeviceId = selectedDeviceId || null;
            
            if (selectedDeviceId) {
                try {
                    const response = await fetch(`${apiUrl}/conversations?device_id=${encodeURIComponent(selectedDeviceId)}&limit=100`);
                    const data = await response.json();
                    if (data.success) {
                        stats.conversations = [];
                        stats.totalDuration = 0;
                        data.conversations.forEach(conv => stats.addConversation(conv));
                    }
                } catch (error) {
                    console.error('Failed to load device conversations:', error);
                }
            } else {
                try {
                    const response = await fetch(`${apiUrl}/conversations?limit=100`);
                    const data = await response.json();
                    if (data.success) {
                        stats.conversations = [];
                        stats.totalDuration = 0;
                        data.conversations.forEach(conv => stats.addConversation(conv));
                    }
                } catch (error) {
                    console.error('Failed to load all conversations:', error);
                }
            }
            
            stats.updateDisplay();
            return false;
        }
        
        function selectDevice(deviceId) {
            const deviceFilterEl = document.getElementById('deviceFilter');
            if (deviceFilterEl) {
                deviceFilterEl.value = deviceId;
                filterByDevice();
            }
        }
        
        function editDeviceName(deviceId, currentName) {
            const name = prompt(`è¯·è¾“å…¥è®¾å¤‡åç§°ï¼ˆè®¾å¤‡ID: ${deviceId}ï¼‰:`, currentName || '');
            if (name !== null) {
                const trimmedName = name.trim();
                if (trimmedName.length === 0) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è®¾å¤‡åç§°å—ï¼Ÿ')) {
                        stats.deleteDeviceName(deviceId);
                    }
                } else {
                    stats.setDeviceName(deviceId, trimmedName);
                }
            }
        }
        
        function deleteDevice(deviceId, deviceDisplayName) {
            const device = Array.from(stats.devices.values()).find(d => d.deviceId === deviceId);
            const conversationCount = device ? device.totalConversations : 0;
            
            let confirmMessage = `ç¡®å®šè¦åˆ é™¤è®¾å¤‡ "${deviceDisplayName}" å—ï¼Ÿ\n\n`;
            confirmMessage += `è¿™å°†åˆ é™¤ï¼š\n- ${conversationCount} æ¡å¯¹è¯è®°å½•\n- è®¾å¤‡åç§°\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
            
            if (confirm(confirmMessage)) {
                stats.deleteDevice(deviceId).then(success => {
                    if (success) {
                        alert(`è®¾å¤‡ "${deviceDisplayName}" å·²åˆ é™¤`);
                    }
                });
            }
        }
        
        const stats = new ConversationStats();
        stats.loadFromLocalStorage();
        window.stats = stats;
    </script>
</body>
</html>