<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºAIå¯¹è¯æ—¶é•¿ç»Ÿè®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        /* è®¾å¤‡å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
        .device-card {
            position: relative;
            cursor: pointer;
        }
        
        .device-card:hover {
            background: #f9fafb;
        }
        
        .device-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .device-card:hover .device-actions {
            opacity: 1;
        }
        
        .device-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .device-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .device-btn:active {
            transform: translateY(0);
        }
        
        .device-btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .device-btn-edit:hover {
            background: #2563eb;
        }
        
        .device-btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .device-btn-delete:hover {
            background: #dc2626;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .conversations-list {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .conversation-item {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            font-size: 13px;
        }
        
        .conversation-item:hover {
            background-color: #f9f9f9;
        }
        
        .conversation-item:last-child {
            border-bottom: none;
        }
        
        .conversation-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .conversation-device {
            font-weight: 500;
            color: #333;
            min-width: 100px;
        }
        
        .conversation-duration {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            min-width: 60px;
        }
        
        .conversation-reason {
            font-size: 12px;
            color: #666;
            padding: 2px 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .conversation-time {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            margin-left: 12px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.connected {
            background: #10b981;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        h1 {
            color: #333;
            margin-bottom: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 20px;
            font-weight: 600;
        }
        
        h3 {
            color: #333;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .connection-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }
        
        .config-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .devices-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .devices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .devices-search {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
        }
        
        .devices-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .devices-search input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .devices-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .devices-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .devices-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .devices-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .devices-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .ranking-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .ranking-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }
        
        .ranking-rank {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 600;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .ranking-rank.top1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
        }
        
        .ranking-rank.top2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #333;
        }
        
        .ranking-rank.top3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e6a85c 100%);
            color: white;
        }
        
        .ranking-rank.other {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        .ranking-info {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        
        .ranking-device {
            font-weight: 500;
            color: #333;
            flex: 1;
        }
        
        .ranking-duration {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            white-space: nowrap;
        }
        
        .ranking-stats {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }
        
        .export-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .export-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .export-btn:active {
            transform: translateY(0);
        }
        
        .config-section label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .config-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .config-section button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .config-section button:hover {
            background: #5568d3;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-info">
                <div>
                    <h1>å°æ™ºAIå¯¹è¯æ—¶é•¿ç»Ÿè®¡</h1>
                    <p style="margin-top: 8px; font-size: 14px; color: #666;">
                        è¿æ¥çŠ¶æ€: <span id="status" class="status disconnected">æœªè¿æ¥</span>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="config-section">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="deviceFilter" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">ç­›é€‰è®¾å¤‡:</label>
                    <select id="deviceFilter" onchange="filterByDevice(event)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white;">
                        <option value="">æ‰€æœ‰è®¾å¤‡</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="devices-section">
            <div class="devices-header">
                <h2 style="margin: 0; color: #333;">è®¾å¤‡åˆ—è¡¨</h2>
                <div class="devices-search">
                    <input type="text" id="deviceSearch" placeholder="æœç´¢è®¾å¤‡åç§°æˆ–ID..." oninput="filterDevicesList()">
                </div>
            </div>
            <div class="devices-container">
                <div id="devicesList" class="devices-grid">
                    <div class="empty-state">æš‚æ— è®¾å¤‡æ•°æ®</div>
                </div>
            </div>
        </div>
        
        <div class="ranking-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0; color: #333;">è®¾å¤‡ä½¿ç”¨æ—¶é•¿æ’è¡Œæ¦œ</h2>
                <button type="button" onclick="exportRankingToExcel()" class="export-btn" id="exportRankingBtn" style="display: none;">
                    ğŸ“¥ å¯¼å‡ºExcel
                </button>
            </div>
            <div id="rankingList" class="ranking-list">
                <div class="empty-state">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">æ€»å¯¹è¯æ¬¡æ•°</div>
                <div class="stat-value" id="totalConversations">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ€»å¯¹è¯æ—¶é•¿</div>
                <div class="stat-value" id="totalDuration">0ç§’</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡å¯¹è¯æ—¶é•¿</div>
                <div class="stat-value" id="avgDuration">0ç§’</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€é•¿å¯¹è¯</div>
                <div class="stat-value" id="maxDuration">0ç§’</div>
            </div>
        </div>
        
        <div class="conversations-list">
            <h2>æœ€è¿‘å¯¹è¯è®°å½•</h2>
            <div id="conversationsList">
                <div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        class ConversationStats {
            constructor() {
                this.ws = null;
                this.conversations = [];
                this.totalDuration = 0;
                this.devices = new Map(); // è®¾å¤‡ç»Ÿè®¡
                this.selectedDeviceId = null; // å½“å‰é€‰ä¸­çš„è®¾å¤‡
                this.apiUrl = 'https://api.xiaozhi.aimaker.space/api'; // API åœ°å€
                this.reconnectTimer = null; // é‡è¿å®šæ—¶å™¨
                this.fixedWsUrl = 'wss://api.xiaozhi.aimaker.space/ws'; // å›ºå®šçš„ WebSocket åœ°å€
                this.init();
            }
            
            init() {
                // è‡ªåŠ¨è¿æ¥ï¼ˆä½¿ç”¨å›ºå®šçš„ WebSocket URLï¼‰
                this.connect(this.fixedWsUrl);
                
                this.updateDisplay();
            }
            
            connect(wsUrl) {
                if (this.ws) {
                    this.ws.close();
                }
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    document.getElementById('status').textContent = 'å·²è¿æ¥';
                    document.getElementById('status').className = 'status connected';
                    
                    // æ¸…é™¤é‡è¿å®šæ—¶å™¨
                    if (this.reconnectTimer) {
                        clearTimeout(this.reconnectTimer);
                        this.reconnectTimer = null;
                    }
                    
                    // åŠ è½½è®¾å¤‡åˆ—è¡¨
                    this.loadDevicesFromAPI();
                    
                    // å‘é€ hello æ¶ˆæ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    this.ws.send(JSON.stringify({
                        type: 'hello',
                        version: 1,
                        transport: 'websocket',
                        audio_params: {
                            format: 'opus',
                            sample_rate: 16000,
                            channels: 1,
                            frame_duration: 60
                        }
                    }));
                };
                
                this.ws.onmessage = (event) => {
                    console.log('ğŸ“¥ Raw message received:', event.data);
                    if (typeof event.data === 'string') {
                        try {
                            const message = JSON.parse(event.data);
                            console.log('âœ… Parsed message:', message);
                            this.handleMessage(message);
                        } catch (e) {
                            console.error('âŒ Failed to parse message:', e, 'Raw data:', event.data);
                        }
                    } else {
                        console.warn('âš ï¸  Received non-string message:', typeof event.data);
                    }
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    document.getElementById('status').textContent = 'è¿æ¥é”™è¯¯';
                    document.getElementById('status').className = 'status disconnected';
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket closed');
                    document.getElementById('status').textContent = 'å·²æ–­å¼€';
                    document.getElementById('status').className = 'status disconnected';
                    
                    // è‡ªåŠ¨é‡è¿ï¼ˆ5ç§’åï¼‰
                    if (!this.reconnectTimer) {
                        console.log('ğŸ”„ Will attempt to reconnect in 5 seconds...');
                        this.reconnectTimer = setTimeout(() => {
                            console.log('ğŸ”„ Attempting to reconnect...');
                            this.reconnectTimer = null;
                            this.connect(wsUrl);
                        }, 5000);
                    }
                };
            }
            
            handleMessage(message) {
                console.log('ğŸ“¨ Received message:', JSON.stringify(message, null, 2));
                
                // å¤„ç†æ¬¢è¿æ¶ˆæ¯
                if (message.type === 'welcome') {
                    console.log('âœ… Welcome message received:', message.message);
                    if (message.stats) {
                        console.log('ğŸ“Š Bridge stats:', message.stats);
                    }
                    if (message.devices) {
                        console.log('ğŸ“± Devices:', message.devices);
                        this.updateDevicesList(message.devices);
                    }
                    return;
                }
                
                // å¤„ç†å¿ƒè·³å“åº”
                if (message.type === 'pong') {
                    console.log('ğŸ’“ Pong received');
                    return;
                }
                
                // å¤„ç†å¯¹è¯ç»Ÿè®¡æ¶ˆæ¯
                if (message.type === 'conversation_stats') {
                    console.log('ğŸ“Š Received conversation stats:', {
                        device_id: message.device_id,
                        session_id: message.session_id,
                        duration: message.duration,
                        reason: message.reason,
                        timestamp: message.timestamp
                    });
                    
                    // éªŒè¯å¿…è¦å­—æ®µ
                    if (typeof message.duration !== 'number') {
                        console.error('âŒ Invalid duration:', message.duration);
                        return;
                    }
                    
                    // éªŒè¯å’Œä¿®å¤æ—¶é—´æˆ³
                    // å¦‚æœæ—¶é—´æˆ³æ— æ•ˆï¼ˆå°äº 2020-01-01ï¼‰ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
                    const minValidTimestamp = 1577836800; // 2020-01-01 00:00:00 UTC
                    let validTimestamp = message.timestamp || Math.floor(Date.now() / 1000);
                    if (validTimestamp < minValidTimestamp) {
                        console.warn(`âš ï¸  Invalid timestamp ${validTimestamp}, using current time`);
                        validTimestamp = Math.floor(Date.now() / 1000);
                    }
                    
                    // è¿‡æ»¤æ‰æ²¡æœ‰ device_id çš„æ¶ˆæ¯ï¼ˆç¦æ­¢ unknown è®¾å¤‡ï¼‰
                    if (!message.device_id) {
                        console.warn('âš ï¸  Ignoring conversation stats without device_id:', message.session_id);
                        return; // ç›´æ¥è¿”å›ï¼Œä¸å¤„ç†
                    }
                    
                    const deviceId = message.device_id;
                    
                    // æ›´æ–°è®¾å¤‡ç»Ÿè®¡
                    if (!this.devices.has(deviceId)) {
                        this.devices.set(deviceId, {
                            deviceId: deviceId,
                            totalConversations: 0,
                            totalDuration: 0
                        });
                    }
                    const device = this.devices.get(deviceId);
                    device.totalConversations++;
                    device.totalDuration += message.duration;
                    
                    // å¦‚æœå½“å‰æ²¡æœ‰ç­›é€‰è®¾å¤‡ï¼Œæˆ–è€…åŒ¹é…å½“å‰è®¾å¤‡ï¼Œæ‰æ·»åŠ åˆ°æ˜¾ç¤ºåˆ—è¡¨
                    if (!this.selectedDeviceId || this.selectedDeviceId === deviceId) {
                        this.addConversation({
                            deviceId: deviceId,
                            sessionId: message.session_id || 'unknown',
                            duration: message.duration || 0,
                            reason: message.reason || 'unknown',
                            timestamp: validTimestamp
                        });
                    }
                    
                    // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
                    this.updateDevicesList(Array.from(this.devices.values()));
                } else {
                    console.log('âš ï¸  Unknown message type:', message.type, message);
                }
            }
            
            addConversation(conversation) {
                console.log('â• Adding conversation:', conversation);
                
                this.conversations.unshift(conversation); // æ·»åŠ åˆ°å¼€å¤´
                this.totalDuration += conversation.duration;
                
                // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
                if (this.conversations.length > 100) {
                    const removed = this.conversations.pop();
                    this.totalDuration -= removed.duration;
                }
                
                // ä¿å­˜åˆ° localStorage
                this.saveToLocalStorage();
                
                // æ›´æ–°æ˜¾ç¤º
                console.log('ğŸ”„ Updating display, total conversations:', this.conversations.length);
                this.updateDisplay();
                
                console.log('âœ… Conversation added successfully');
            }
            
            getDeviceDisplayName(device) {
                return device.deviceName || device.deviceId || 'unknown';
            }
            
            updateDevicesList(devices) {
                // è¿‡æ»¤æ‰ unknown è®¾å¤‡ï¼ˆåŒé‡ä¿æŠ¤ï¼‰
                devices = devices.filter(device => 
                    device.deviceId && 
                    device.deviceId !== 'unknown' && 
                    device.deviceId !== '' && 
                    device.deviceId !== null
                );
                
                // ä¿å­˜æ‰€æœ‰è®¾å¤‡æ•°æ®ä¾›æœç´¢ä½¿ç”¨
                this.allDevices = devices;
                
                const devicesListEl = document.getElementById('devicesList');
                const deviceFilterEl = document.getElementById('deviceFilter');
                
                if (!devicesListEl || !deviceFilterEl) return;
                
                // æ›´æ–°è®¾å¤‡ç­›é€‰ä¸‹æ‹‰æ¡†
                const currentValue = deviceFilterEl.value;
                deviceFilterEl.innerHTML = '<option value="">æ‰€æœ‰è®¾å¤‡</option>';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    const displayName = this.getDeviceDisplayName(device);
                    option.textContent = `${displayName} (${device.totalConversations}æ¬¡å¯¹è¯)`;
                    if (currentValue === device.deviceId) {
                        option.selected = true;
                    }
                    deviceFilterEl.appendChild(option);
                });
                
                // åº”ç”¨æœç´¢è¿‡æ»¤
                this.renderDevicesList(devices);
                
                // æ›´æ–°æ’è¡Œæ¦œ
                this.updateRanking(devices);
            }
            
            renderDevicesList(devices) {
                const devicesListEl = document.getElementById('devicesList');
                if (!devicesListEl) return;
                
                // è·å–æœç´¢å…³é”®è¯
                const searchInput = document.getElementById('deviceSearch');
                const searchKeyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
                
                // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œè¿‡æ»¤è®¾å¤‡
                let filteredDevices = devices;
                if (searchKeyword) {
                    filteredDevices = devices.filter(device => {
                        const displayName = this.getDeviceDisplayName(device).toLowerCase();
                        const deviceId = (device.deviceId || '').toLowerCase();
                        return displayName.includes(searchKeyword) || deviceId.includes(searchKeyword);
                    });
                }
                
                // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
                if (filteredDevices.length === 0) {
                    devicesListEl.innerHTML = '<div class="empty-state">' + 
                        (searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡' : 'æš‚æ— è®¾å¤‡æ•°æ®') + 
                        '</div>';
                    return;
                }
                
                devicesListEl.innerHTML = filteredDevices.map(device => {
                    const displayName = this.getDeviceDisplayName(device);
                    return `
                    <div class="stat-card device-card" onclick="selectDevice('${device.deviceId}')">
                        <div class="device-actions">
                            <button type="button" class="device-btn device-btn-edit" onclick="event.stopPropagation(); editDeviceName('${device.deviceId}', '${(device.deviceName || '').replace(/'/g, "\\'")}')">
                                ${device.deviceName ? 'âœï¸' : 'â•'} åç§°
                            </button>
                            <button type="button" class="device-btn device-btn-delete" onclick="event.stopPropagation(); deleteDevice('${device.deviceId}', '${displayName.replace(/'/g, "\\'")}')">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                        <div class="stat-label">${device.deviceName ? 'è®¾å¤‡åç§°' : 'è®¾å¤‡ ID'}</div>
                        <div class="stat-value" style="font-size: ${device.deviceName ? '16px' : '14px'}; word-break: break-all;">
                            ${displayName}
                            ${device.deviceName ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">${device.deviceId}</div>` : ''}
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <div>å¯¹è¯æ¬¡æ•°: ${device.totalConversations}</div>
                            <div>æ€»æ—¶é•¿: ${this.formatDuration(device.totalDuration)}</div>
                            <div>å¹³å‡æ—¶é•¿: ${device.totalConversations > 0 ? this.formatDuration(device.totalDuration / device.totalConversations) : '0ç§’'}</div>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            updateRanking(devices) {
                const rankingListEl = document.getElementById('rankingList');
                const exportBtn = document.getElementById('exportRankingBtn');
                if (!rankingListEl) return;
                
                // è¿‡æ»¤æ‰ unknown è®¾å¤‡å¹¶æŒ‰æ€»æ—¶é•¿é™åºæ’åº
                const rankedDevices = devices
                    .filter(device => 
                        device.deviceId && 
                        device.deviceId !== 'unknown' && 
                        device.deviceId !== '' && 
                        device.deviceId !== null &&
                        device.totalDuration > 0
                    )
                    .sort((a, b) => (b.totalDuration || 0) - (a.totalDuration || 0));
                
                // ä¿å­˜æ’è¡Œæ¦œæ•°æ®ä¾›å¯¼å‡ºä½¿ç”¨
                this.rankedDevices = rankedDevices;
                
                // æ˜¾ç¤º/éšè—å¯¼å‡ºæŒ‰é’®
                if (exportBtn) {
                    exportBtn.style.display = rankedDevices.length > 0 ? 'inline-flex' : 'none';
                }
                
                if (rankedDevices.length === 0) {
                    rankingListEl.innerHTML = '<div class="empty-state">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>';
                    return;
                }
                
                rankingListEl.innerHTML = rankedDevices.map((device, index) => {
                    const rank = index + 1;
                    const displayName = this.getDeviceDisplayName(device);
                    const rankClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : 'other';
                    const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
                    
                    return `
                        <div class="ranking-item" onclick="selectDevice('${device.deviceId}')">
                            <div class="ranking-rank ${rankClass}">${rankIcon}</div>
                            <div class="ranking-info">
                                <div class="ranking-device">${displayName}</div>
                                <div class="ranking-duration">${this.formatDuration(device.totalDuration)}</div>
                                <div class="ranking-stats">${device.totalConversations}æ¬¡å¯¹è¯</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            exportRankingToExcel() {
                if (!this.rankedDevices || this.rankedDevices.length === 0) {
                    alert('æš‚æ— æ’è¡Œæ¦œæ•°æ®å¯å¯¼å‡º');
                    return;
                }
                
                // å‡†å¤‡CSVæ•°æ®
                const headers = ['æ’å', 'æ ¡åŒº', 'ä½¿ç”¨æ—¶é•¿', 'å¯¹è¯æ¬¡æ•°'];
                const rows = this.rankedDevices.map((device, index) => {
                    const rank = index + 1;
                    const campus = this.getDeviceDisplayName(device);
                    const duration = this.formatDuration(device.totalDuration);
                    const conversations = device.totalConversations || 0;
                    
                    return [rank, campus, duration, conversations];
                });
                
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => {
                        // å¤„ç†åŒ…å«é€—å·æˆ–å¼•å·çš„å•å…ƒæ ¼
                        const cellStr = String(cell);
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    }).join(','))
                ].join('\n');
                
                // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡ï¼ˆUTF-8 with BOMï¼‰
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«å½“å‰æ—¥æœŸï¼‰
                const now = new Date();
                const dateStr = now.getFullYear() + 
                               String(now.getMonth() + 1).padStart(2, '0') + 
                               String(now.getDate()).padStart(2, '0');
                link.setAttribute('download', `è®¾å¤‡ä½¿ç”¨æ—¶é•¿æ’è¡Œæ¦œ_${dateStr}.csv`);
                
                // è§¦å‘ä¸‹è½½
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('âœ… æ’è¡Œæ¦œæ•°æ®å·²å¯¼å‡º');
            }
            
            async setDeviceName(deviceId, name) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/devices/${encodeURIComponent(deviceId)}/name`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log(`âœ… Device name set: ${deviceId} -> ${name}`);
                        // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                        await this.loadDevicesFromAPI();
                        return true;
                    } else {
                        console.error('Failed to set device name:', data.error);
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to set device name:', error);
                    return false;
                }
            }
            
            async deleteDeviceName(deviceId) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/devices/${encodeURIComponent(deviceId)}/name`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log(`âœ… Device name removed: ${deviceId}`);
                        // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                        await this.loadDevicesFromAPI();
                        return true;
                    } else {
                        console.error('Failed to delete device name:', data.error);
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to delete device name:', error);
                    return false;
                }
            }
            
            async deleteDevice(deviceId) {
                const apiUrl = getApiUrl();
                try {
                    const response = await fetch(`${apiUrl}/devices/${encodeURIComponent(deviceId)}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log(`âœ… Device deleted: ${deviceId} (${data.deletedConversations} conversations)`);
                        
                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„è®¾å¤‡ï¼Œæ¸…é™¤ç­›é€‰
                        if (this.selectedDeviceId === deviceId) {
                            this.selectedDeviceId = null;
                            const deviceFilterEl = document.getElementById('deviceFilter');
                            if (deviceFilterEl) deviceFilterEl.value = '';
                        }
                        
                        // ä»æœ¬åœ°è®¾å¤‡ Map ä¸­ç§»é™¤
                        this.devices.delete(deviceId);
                        
                        // åˆ é™¤è¯¥è®¾å¤‡çš„æ‰€æœ‰å¯¹è¯è®°å½•
                        const beforeCount = this.conversations.length;
                        this.conversations = this.conversations.filter(c => c.deviceId !== deviceId);
                        const deletedCount = beforeCount - this.conversations.length;
                        
                        // é‡æ–°è®¡ç®—æ€»æ—¶é•¿
                        this.totalDuration = this.conversations.reduce((sum, c) => sum + c.duration, 0);
                        
                        // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                        await this.loadDevicesFromAPI();
                        
                        // æ›´æ–°æ˜¾ç¤º
                        this.updateDisplay();
                        
                        // ä¿å­˜åˆ° localStorage
                        this.saveToLocalStorage();
                        
                        return true;
                    } else {
                        console.error('Failed to delete device:', data.error);
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to delete device:', error);
                    return false;
                }
            }
            
            async loadDevicesFromAPI() {
                try {
                    // ä½¿ç”¨å›ºå®šçš„ API URL
                    const apiUrl = this.apiUrl;
                    
                    console.log(`ğŸ“¡ Loading devices from API: ${apiUrl}/devices`);
                    const response = await fetch(`${apiUrl}/devices`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success && data.devices) {
                        console.log(`âœ… Loaded ${data.devices.length} devices`);
                        // æ¸…ç©ºå¹¶æ›´æ–°æœ¬åœ°è®¾å¤‡ Mapï¼ˆç¡®ä¿ä½¿ç”¨ API è¿”å›çš„å®Œæ•´æ•°æ®ï¼‰
                        this.devices.clear();
                        data.devices.forEach(device => {
                            this.devices.set(device.deviceId, device);
                        });
                        // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
                        this.updateDevicesList(data.devices);
                        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºï¼ˆåŸºäºè®¾å¤‡æ•°æ®ï¼‰
                        this.updateDisplay();
                    }
                } catch (error) {
                    console.error('âŒ Failed to load devices:', error);
                    console.error('ğŸ’¡ Make sure the bridge service is running on port 3000');
                }
            }
            
            saveToLocalStorage() {
                try {
                    localStorage.setItem('conversations', JSON.stringify({
                        conversations: this.conversations,
                        totalDuration: this.totalDuration,
                        selectedDeviceId: this.selectedDeviceId
                    }));
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                }
            }
            
            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('conversations');
                    if (saved) {
                        const data = JSON.parse(saved);
                        // åªåŠ è½½ conversations ç”¨äºæ˜¾ç¤ºæœ€è¿‘å¯¹è¯è®°å½•
                        // æ³¨æ„ï¼šä¸è¦åŸºäº conversations é‡å»ºè®¾å¤‡ç»Ÿè®¡ï¼Œå› ä¸º conversations åªä¿å­˜æœ€è¿‘100æ¡
                        // è®¾å¤‡ç»Ÿè®¡åº”è¯¥å®Œå…¨ä¾èµ–ä» API åŠ è½½çš„æ•°æ®
                        this.conversations = (data.conversations || []).filter(conv => 
                            conv.deviceId && 
                            conv.deviceId !== 'unknown' && 
                            conv.deviceId !== '' && 
                            conv.deviceId !== null
                        );
                        this.selectedDeviceId = data.selectedDeviceId || null;
                        
                        // æ¢å¤è®¾å¤‡ç­›é€‰
                        const deviceFilterEl = document.getElementById('deviceFilter');
                        if (deviceFilterEl && this.selectedDeviceId) {
                            deviceFilterEl.value = this.selectedDeviceId;
                        }
                        
                        // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨ updateDisplay()ï¼Œå› ä¸ºè®¾å¤‡ç»Ÿè®¡è¿˜æ²¡æœ‰åŠ è½½
                        // è®¾å¤‡ç»Ÿè®¡ä¼šåœ¨ loadDevicesFromAPI() å®Œæˆåè‡ªåŠ¨æ›´æ–°
                    }
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                }
            }
            
            formatDuration(seconds) {
                if (seconds < 60) {
                    return seconds.toFixed(1) + 'ç§’';
                } else if (seconds < 3600) {
                    const mins = Math.floor(seconds / 60);
                    const secs = (seconds % 60).toFixed(1);
                    return mins + 'åˆ†' + secs + 'ç§’';
                } else {
                    const hours = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    return hours + 'å°æ—¶' + mins + 'åˆ†é’Ÿ';
                }
            }
            
            formatTime(timestamp) {
                // å¦‚æœæ—¶é—´æˆ³æ˜¯æœ¬åœ°æ—¶é—´æˆ³ï¼ˆUTC+8ï¼‰ï¼Œéœ€è¦å‡å»8å°æ—¶è½¬æ¢ä¸ºUTCæ—¶é—´æˆ³
                // ä¸­å›½æ—¶åŒº UTC+8ï¼Œæ‰€ä»¥å‡å» 8 * 3600 = 28800 ç§’
                const utcTimestamp = timestamp - 8 * 3600;
                const date = new Date(utcTimestamp * 1000);
                const now = new Date();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©ï¼ˆä½¿ç”¨æœ¬åœ°æ—¶é—´çš„å¹´æœˆæ—¥æ¯”è¾ƒï¼‰
                const isToday = date.getDate() === now.getDate() && 
                                date.getMonth() === now.getMonth() && 
                                date.getFullYear() === now.getFullYear();
                
                // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
                if (isToday) {
                    // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–ï¼Œç¡®ä¿æ˜¾ç¤ºç³»ç»Ÿæ—¶é—´
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${hours}:${minutes}:${seconds}`;
                }
                
                // å¦‚æœæ˜¯ä»Šå¹´ï¼Œæ˜¾ç¤ºæœˆ-æ—¥ æ—¶:åˆ†
                if (date.getFullYear() === now.getFullYear()) {
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${month}/${day} ${hours}:${minutes}`;
                }
                
                // å…¶ä»–æƒ…å†µæ˜¾ç¤ºå®Œæ•´æ—¥æœŸæ—¶é—´
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            }
            
            updateDisplay() {
                // åŸºäºè®¾å¤‡åˆ—è¡¨æ•°æ®è®¡ç®—ç»Ÿè®¡ï¼ˆè€Œä¸æ˜¯åŸºäº conversations æ•°ç»„ï¼Œå› ä¸º conversations åªä¿å­˜æœ€è¿‘100æ¡ï¼‰
                let devices = Array.from(this.devices.values()).filter(device => 
                    device.deviceId && 
                    device.deviceId !== 'unknown' && 
                    device.deviceId !== '' && 
                    device.deviceId !== null
                );
                
                // å¦‚æœé€‰ä¸­äº†ç‰¹å®šè®¾å¤‡ï¼Œåªç»Ÿè®¡è¯¥è®¾å¤‡
                if (this.selectedDeviceId) {
                    devices = devices.filter(device => device.deviceId === this.selectedDeviceId);
                }
                
                // åŸºäºè®¾å¤‡æ•°æ®è®¡ç®—ç»Ÿè®¡
                const count = devices.reduce((sum, device) => sum + (device.totalConversations || 0), 0);
                const total = devices.reduce((sum, device) => sum + (device.totalDuration || 0), 0);
                const avg = count > 0 ? total / count : 0;
                
                // æœ€é•¿å¯¹è¯éœ€è¦ä» conversations æ•°ç»„ä¸­æŸ¥æ‰¾ï¼ˆå› ä¸ºè®¾å¤‡æ•°æ®ä¸­æ²¡æœ‰å•æ¬¡å¯¹è¯çš„æœ€å¤§å€¼ï¼‰
                let filteredConversations = this.conversations.filter(c => 
                    c.deviceId && 
                    c.deviceId !== 'unknown' && 
                    c.deviceId !== '' && 
                    c.deviceId !== null
                );
                if (this.selectedDeviceId) {
                    filteredConversations = filteredConversations.filter(c => c.deviceId === this.selectedDeviceId);
                }
                const max = filteredConversations.length > 0 ? Math.max(...filteredConversations.map(c => c.duration || 0)) : 0;
                
                console.log('ğŸ“Š Display stats:', { count, total, avg, max, deviceId: this.selectedDeviceId, devicesCount: devices.length });
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                const totalConversationsEl = document.getElementById('totalConversations');
                const totalDurationEl = document.getElementById('totalDuration');
                const avgDurationEl = document.getElementById('avgDuration');
                const maxDurationEl = document.getElementById('maxDuration');
                
                if (totalConversationsEl) totalConversationsEl.textContent = count;
                if (totalDurationEl) totalDurationEl.textContent = this.formatDuration(total);
                if (avgDurationEl) avgDurationEl.textContent = this.formatDuration(avg);
                if (maxDurationEl) maxDurationEl.textContent = this.formatDuration(max);
                
                // æ›´æ–°å¯¹è¯åˆ—è¡¨
                const listElement = document.getElementById('conversationsList');
                if (!listElement) {
                    console.error('âŒ conversationsList element not found');
                    return;
                }
                
                if (filteredConversations.length === 0) {
                    listElement.innerHTML = '<div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>';
                } else {
                    // æŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰ï¼Œç„¶ååªæ˜¾ç¤ºæœ€è¿‘çš„5æ¡å¯¹è¯è®°å½•
                    const recentConversations = filteredConversations
                        .filter(conv => conv.deviceId && conv.deviceId !== 'unknown')
                        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)) // æŒ‰æ—¶é—´æˆ³é™åºæ’åº
                        .slice(0, 5);
                    
                    if (recentConversations.length === 0) {
                        listElement.innerHTML = '<div class="empty-state">æš‚æ— å¯¹è¯è®°å½•</div>';
                    } else {
                        listElement.innerHTML = recentConversations.map(conv => {
                            const device = this.devices.get(conv.deviceId);
                            const deviceDisplayName = device ? this.getDeviceDisplayName(device) : conv.deviceId;
                            return `
                            <div class="conversation-item">
                                <div class="conversation-info">
                                    <span class="conversation-device">${deviceDisplayName}</span>
                                    <span class="conversation-duration">${this.formatDuration(conv.duration)}</span>
                                    <span class="conversation-reason">${conv.reason}</span>
                                </div>
                                <div class="conversation-time">${this.formatTime(conv.timestamp)}</div>
                            </div>
                        `;
                        }).join('');
                    }
                }
                
                console.log('âœ… Display updated');
            }
        }
        
        // å…¨å±€å‡½æ•°
        function connectWebSocket(event) {
            // é˜²æ­¢è¡¨å•æäº¤
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // WebSocket ä¼šè‡ªåŠ¨è¿æ¥ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹æ€§
            // å¦‚æœéœ€è¦æ‰‹åŠ¨é‡è¿ï¼Œå¯ä»¥ä½¿ç”¨å›ºå®šçš„ WebSocket URL
            if (stats && stats.fixedWsUrl) {
                stats.connect(stats.fixedWsUrl);
            }
            return false;
        }
        
        // è·å– API URLï¼ˆå›ºå®šåœ°å€ï¼‰
        function getApiUrl() {
            return 'https://api.xiaozhi.aimaker.space/api';
        }
        
        // å¯¼å‡ºæ’è¡Œæ¦œåˆ°Excel
        function exportRankingToExcel() {
            if (stats && stats.exportRankingToExcel) {
                stats.exportRankingToExcel();
            } else {
                alert('æ’è¡Œæ¦œæ•°æ®æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');
            }
        }
        
        // è¿‡æ»¤è®¾å¤‡åˆ—è¡¨ï¼ˆæœç´¢åŠŸèƒ½ï¼‰
        function filterDevicesList() {
            if (stats && stats.allDevices) {
                stats.renderDevicesList(stats.allDevices);
            }
        }
        
        // ç­›é€‰è®¾å¤‡
        async function filterByDevice(event) {
            // é˜²æ­¢è¡¨å•æäº¤
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const deviceFilterEl = document.getElementById('deviceFilter');
            const selectedDeviceId = deviceFilterEl ? deviceFilterEl.value : '';
            const apiUrl = getApiUrl();
            
            stats.selectedDeviceId = selectedDeviceId || null;
            
            // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
            if (selectedDeviceId) {
                // ä» API åŠ è½½è¯¥è®¾å¤‡çš„å¯¹è¯
                try {
                    const response = await fetch(`${apiUrl}/conversations?device_id=${encodeURIComponent(selectedDeviceId)}&limit=100`);
                    const data = await response.json();
                    if (data.success) {
                        // æ¸…ç©ºå½“å‰åˆ—è¡¨ï¼Œé‡æ–°åŠ è½½
                        stats.conversations = [];
                        stats.totalDuration = 0;
                        data.conversations.forEach(conv => {
                            stats.addConversation(conv);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load device conversations:', error);
                }
            } else {
                // åŠ è½½æ‰€æœ‰è®¾å¤‡çš„å¯¹è¯
                try {
                    const response = await fetch(`${apiUrl}/conversations?limit=100`);
                    const data = await response.json();
                    if (data.success) {
                        stats.conversations = [];
                        stats.totalDuration = 0;
                        data.conversations.forEach(conv => {
                            stats.addConversation(conv);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load all conversations:', error);
                }
            }
            
            stats.updateDisplay();
            return false;
        }
        
        // é€‰æ‹©è®¾å¤‡
        function selectDevice(deviceId) {
            const deviceFilterEl = document.getElementById('deviceFilter');
            if (deviceFilterEl) {
                deviceFilterEl.value = deviceId;
                filterByDevice();
            }
        }
        
        // ç¼–è¾‘è®¾å¤‡åç§°
        function editDeviceName(deviceId, currentName) {
            const name = prompt(`è¯·è¾“å…¥è®¾å¤‡åç§°ï¼ˆè®¾å¤‡ID: ${deviceId}ï¼‰:`, currentName || '');
            if (name !== null) {
                const trimmedName = name.trim();
                if (trimmedName.length === 0) {
                    // å¦‚æœåç§°ä¸ºç©ºï¼Œåˆ é™¤è®¾å¤‡åç§°
                    if (confirm('ç¡®å®šè¦åˆ é™¤è®¾å¤‡åç§°å—ï¼Ÿ')) {
                        stats.deleteDeviceName(deviceId);
                    }
                } else {
                    stats.setDeviceName(deviceId, trimmedName);
                }
            }
        }
        
        // åˆ é™¤è®¾å¤‡
        function deleteDevice(deviceId, deviceDisplayName) {
            const device = Array.from(stats.devices.values()).find(d => d.deviceId === deviceId);
            const conversationCount = device ? device.totalConversations : 0;
            
            let confirmMessage = `ç¡®å®šè¦åˆ é™¤è®¾å¤‡ "${deviceDisplayName}" å—ï¼Ÿ\n\n`;
            confirmMessage += `è¿™å°†åˆ é™¤ï¼š\n`;
            confirmMessage += `- ${conversationCount} æ¡å¯¹è¯è®°å½•\n`;
            confirmMessage += `- è®¾å¤‡åç§°ï¼ˆå¦‚æœå·²è®¾ç½®ï¼‰\n\n`;
            confirmMessage += `æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
            
            if (confirm(confirmMessage)) {
                stats.deleteDevice(deviceId).then(success => {
                    if (success) {
                        alert(`è®¾å¤‡ "${deviceDisplayName}" å·²åˆ é™¤`);
                    } else {
                        alert(`åˆ é™¤è®¾å¤‡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…`);
                    }
                });
            }
        }
        
        // åˆå§‹åŒ–
        const stats = new ConversationStats();
        
        // é¡µé¢åŠ è½½æ—¶ä» localStorage æ¢å¤æ•°æ®
        stats.loadFromLocalStorage();
        
        // æ·»åŠ å…¨å±€è°ƒè¯•å‡½æ•°
        window.stats = stats;
        console.log('ğŸ’¡ è°ƒè¯•æç¤ºï¼šåœ¨æ§åˆ¶å°è¾“å…¥ stats æŸ¥çœ‹ç»Ÿè®¡å¯¹è±¡');
    </script>
</body>
</html>

